<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Vyvia Dialogue Workbench v2.2</title>
    <style>
        :root {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --primary-color: #0d8eff;
            --border-color: #444; --button-bg: #2a2a2a; --button-hover-bg: #3c3c3c;
            --button-active-bg: #0d8eff; --input-bg: #252526;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0;
            padding: 20px; box-sizing: border-box;
        }
        .container { width: 95%; max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; font-weight: 300; color: var(--primary-color); margin-bottom: 20px; }
        .workbench-section { padding: 20px; background-color: #1e1e1e; border-radius: 8px; margin-bottom: 25px;}
        .input-group { display: flex; flex-direction: column; gap: 15px; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .context-inputs { display: flex; flex-grow: 1; gap: 10px; } /* --- NUEVO --- */
        .context-input { /* --- MODIFICADO --- */
            padding: 8px 12px; background-color: var(--input-bg);
            border: 1px solid var(--border-color); color: var(--text-color); border-radius: 6px;
        }
        #chat-session-input { width: 60px; } /* v2.2 - Ancho fijo para optimizar layout */
                #project-context-input { flex-grow: 1; } /* --- NUEVO --- */
        #project-selector-container { display: flex; flex-grow: 1; gap: 10px; } /* --- v2.0 --- */
        #project-selector { flex-grow: 1; } /* --- v2.0 --- */
        .manage-button { padding: 8px 12px; font-size: 13px; background-color: var(--button-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; color: var(--text-color); }
        #manage-categories-btn { float: right; font-size: 12px; padding: 5px 10px; }
        .manage-button:hover { background-color: var(--button-hover-bg); border-color: var(--primary-color); } /* --- v2.0 --- */

        /* --- ESTILOS MODAL v2.0 --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content {
     background-color: #2a2a2a;
     margin: auto;
     padding: 25px;
     border: 1px solid var(--border-color);
     border-radius: 10px;
     width: 90%;
     max-width: 700px;
     box-shadow: 0 5px 15px rgba(0,0,0,0.3);
     position: relative;
     overflow: auto; /* v2.2 - Manejar contenido que desborda */
     resize: both;   /* v2.2 - Habilitar redimensionamiento */
 } 
        .modal-content h2 { margin-top: 0; color: var(--primary-color); }
        .modal-close-btn { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .project-list { list-style: none; padding: 0; margin: 20px 0; max-height: 400px; overflow-y: auto; } /* v2.2 - Altura de lista aumentada */
        .project-list-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; border-bottom: 1px solid var(--border-color); border-radius: 15px; background-color: var(--button-bg); }
        .project-list-item:last-child { border-bottom: none; }
        .delete-project-btn { background: none; border: none; color: #ff4d4d; font-size: 18px; cursor: pointer; }
        .add-project-form { display: flex; gap: 10px; margin-top: 20px; }
        .directive-category-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .add-project-form input { flex-grow: 1; }
        .add-project-btn { padding: 8px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; }
        .mode-selector { display: flex; gap: 10px; }
        .mode-button {
            padding: 8px 15px; font-size: 14px; color: var(--text-color);
            background-color: var(--button-bg); border: 1px solid var(--border-color);
            border-radius: 20px; cursor: pointer; transition: all 0.2s;
        }
        .mode-button:hover { background-color: var(--button-hover-bg); border-color: var(--primary-color); }
        .mode-button.active { background-color: var(--button-active-bg); color: white; border-color: var(--button-active-bg); }
        textarea {
            width: 100%; background-color: var(--input-bg);
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; font-size: 16px; line-height: 1.6;
            resize: vertical; box-sizing: border-box;
        }
        #message-input { height: 35vh; }
        .main-button {
            padding: 12px 20px; font-size: 16px; font-weight: 600;
            color: var(--text-color); background-color: var(--button-bg);
            border: 1px solid var(--primary-color); border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s; align-self: flex-start;
        }
        .main-button:hover { background-color: var(--button-hover-bg); }

        .directive-input-container  {
            margin-bottom: -5px; /* Ajusta el espacio entre la directiva y el área de mensaje */
        }

 #active-directives-display { 
     min-height: 38px; /* Altura similar a un input */ 
     display: flex; 
     flex-wrap: wrap; 
     gap: 8px; 
     align-items: center; 
 } 
 .directive-item {
     display: inline-flex;
     align-items: center;
     padding: 5px 10px;
     border: 1px solid var(--border-color);
     border-radius: 15px; /* <-- Clave para redondear */
     cursor: pointer;
     transition: all 0.2s;
 }

 .active-directive-tag,
.directive-item {
    display: inline-flex;
    align-items: center;
    padding: 5px 12px;
    border: 1px solid var(--border-color);
    border-radius: 15px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin: 2px; /* Añadir un pequeño margen */
} 
 .remove-directive-btn { 
     background: none; 
     border: none; 
     color: white; 
     margin-left: 8px; 
     padding: 0; 
     cursor: pointer; 
     font-size: 16px; 
     line-height: 1; 
     opacity: 0.7; 
 } 
 .remove-directive-btn:hover { 
     opacity: 1; 
 } 
/* Paleta de Colores por Categoría v1.0 */
.directive-item[data-category="Modo Cognitivo"] { background-color: #3a2e5c; border-color: #5c4a91; }
.directive-item[data-category="Control de Ejecución"] { background-color: #5e4925; border-color: #a37d3b; }
.directive-item[data-category="Formato de Salida"] { background-color: #26555e; border-color: #3b8a99; }

/* Estilo para el estado seleccionado (más sutil) */
.directive-item.selected {
    box-shadow: 0 0 0 2px var(--primary-color);
    /* Se elimina el cambio de color de fondo para mantener el color de la categoría */
}

        #protocol-directive-input {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* --- ESTILOS PARA NOTAS RÁPIDAS (NUEVO) --- */
        #quick-notes-section { border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px;}
        #quick-notes-section h3 { margin-top: 0; font-weight: 500; color: #aaa;}
        #notes-input { height: 15vh; font-size: 14px; }
        
        footer { text-align: center; font-size: 12px; color: #888; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="container">
                <h1>Vyvia Dialogue Workbench v2.1</h1>
        
        <div class="workbench-section">
            <div class="input-group">
                <div class="controls">
                    <!-- --- MODIFICADO: Inputs de Contexto --- -->
                    <!-- --- MODIFICADO v2.0: Gestión de Proyectos --- -->
                    <div class="context-inputs">
                        <input type="text" id="chat-session-input" class="context-input" placeholder="Sesión (ej. C9.1)">
                        <div id="project-selector-container" class="context-input">
                            <select id="project-selector" class="context-input" style="border: none; padding-left: 0;"></select>
                        </div>
                        <button id="manage-projects-btn" class="manage-button">Proyectos</button>
                        <button id="manage-directives-btn" class="manage-button">Directivas</button>
                    </div>

                </div>
                <div class="directive-input-container">
                    <div id="active-directives-display" class="context-input"></div>
                </div>
                <textarea id="message-input" placeholder="Escribe tu mensaje aquí..."></textarea>
                <button id="copy-button" class="main-button">Copiar con Cabecera</button>

                <!-- --- NUEVO: Sección de Notas Rápidas --- -->
                <div id="quick-notes-section">
                     <h3>Captura Rápida de Ideas</h3>
                     <textarea id="notes-input" placeholder="Escribe aquí una nota rápida..."></textarea>
                     <button id="copy-note-button" class="main-button" style="font-size: 14px; padding: 8px 15px;">Copiar Nota al Portapapeles</button>
                </div>
            </div>
        </div>

        <!-- --- MODAL GESTIÓN DE PROYECTOS v2.0 --- -->
                <!-- --- MODAL GESTIÓN DE DIRECTIVAS v2.1 --- -->
        <div id="directives-modal" class="modal-overlay">
            <div class="modal-content">
                <span id="directives-modal-close-btn" class="modal-close-btn">&times;</span>
                <h2>Gestionar Directivas de Protocolo</h2>
                <button id="manage-categories-btn" class="manage-button">Gestionar Categorías</button>
                <div id="directives-list" class="project-list"></div> <!-- Reutilizamos la clase .project-list para la lista de directivas -->
                <div class="add-project-form">
                    <input type="text" id="new-directive-text-input" class="context-input" placeholder="Texto de la directiva, ej. [INFO: ...]" style="flex-grow: 3;">
                    <select id="new-directive-category-selector" class="context-input" style="flex-grow: 1;"></select>
                    <button id="add-directive-btn" class="add-project-btn">+</button>
                </div>
            </div>
        </div>

        <div id="project-modal" class="modal-overlay">
            <div class="modal-content">
                <span id="modal-close-btn" class="modal-close-btn">&times;</span>
                <h2>Gestionar Proyectos</h2>
                <ul id="project-list" class="project-list"></ul>
                <div class="add-project-form">
                    <input type="text" id="new-project-input" class="context-input" placeholder="Nombre del nuevo proyecto">
                    <button id="add-project-btn" class="add-project-btn">+</button>
                </div>
            </div>
        </div>

        <footer>Forjado por la Simbiosis Director-Guardián</footer>
    </div>

    <script>
        // --- Lógica del Compositor de Mensajes ---
        // --- Lógica del Compositor de Mensajes ---
        const messageInput = document.getElementById('message-input');
        const copyButton = document.getElementById('copy-button');
        const chatSessionInput = document.getElementById('chat-session-input');

        // --- INICIO LÓGICA GESTIÓN DE PROYECTOS v2.0 ---
        const projectSelector = document.getElementById('project-selector');
        const manageProjectsBtn = document.getElementById('manage-projects-btn');
        const projectModal = document.getElementById('project-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const projectList = document.getElementById('project-list');
        const newProjectInput = document.getElementById('new-project-input');
        const addProjectBtn = document.getElementById('add-project-btn');

        let projects = [];

        // --- INICIO LÓGICA GESTIÓN DE DIRECTIVAS v2.1 ---
        const manageDirectivesBtn = document.getElementById('manage-directives-btn');
        const directivesModal = document.getElementById('directives-modal');
        const directivesModalCloseBtn = document.getElementById('directives-modal-close-btn');
        const directivesList = document.getElementById('directives-list');
        const newDirectiveTextInput = document.getElementById('new-directive-text-input');
        const newDirectiveCategoryInput = document.getElementById('new-directive-category-input');
        const addDirectiveBtn = document.getElementById('add-directive-btn');

        let directives = [];
        let activeDirectives = [];
        let categories = [];

        function renderActiveDirectives() { 
     const displayContainer = document.getElementById('active-directives-display'); 
     displayContainer.innerHTML = ''; // Limpiar 
     activeDirectives.forEach(directiveText => { 
         const tag = document.createElement('div');
         tag.className = 'active-directive-tag';
         const directiveData = directives.find(d => d.text === directiveText);
         if (directiveData) {
            tag.dataset.category = directiveData.category;
         }
         tag.textContent = directiveText; 
 
         const removeBtn = document.createElement('button'); 
         removeBtn.className = 'remove-directive-btn'; 
         removeBtn.innerHTML = '×'; 
         removeBtn.onclick = () => { 
             const index = activeDirectives.indexOf(directiveText); 
             if (index > -1) { 
                 activeDirectives.splice(index, 1); 
                 renderActiveDirectives(); // Actualizar UI 
                 renderDirectives();
            renderCategorySelector(); // Actualizar estado visual del modal 
             } 
         }; 
         tag.appendChild(removeBtn); 
         displayContainer.appendChild(tag); 
     }); 
 }

function renderCategorySelector() {
    const selector = document.getElementById('new-directive-category-selector');
    selector.innerHTML = '';
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        selector.appendChild(option);
    });
}

        function loadDirectives() {
            const storedDirectives = localStorage.getItem('vyvia_directives');
            if (storedDirectives) {
                directives = JSON.parse(storedDirectives);
            } else {
                // Datos iniciales con categorías
                directives = [
                    // Modo Cognitivo
                    { text: '[MODE: DEEP_FOCUS]', category: 'Modo Cognitivo' },
                    { text: '[MODE: QUICK_INJECT]', category: 'Modo Cognitivo' },
                    { text: '[MODE: LIGHT_CONNECT]', category: 'Modo Cognitivo' },
                    { text: '[SET_ACTIVE_SYMBOL]', category: 'Modo Cognitivo' },
                    { text: '[SET_RELEVANT_CONTEXT]', category: 'Modo Cognitivo' },
                    // Control de Ejecución
                    { text: '[ENFORCE: GIT_BLOCK]', category: 'Control de Ejecución' },
                    { text: '[ENFORCE: NO_TOOL_CALL]', category: 'Control de Ejecución' },
                    { text: '[ENFORCE: TOOL_CALL]', category: 'Control de Ejecución' },
                    { text: '[AWAIT_USER_FEEDBACK]', category: 'Control de Ejecución' },
                    { text: '[AWAIT_USER_APPROVAL]', category: 'Control de Ejecución' },
                    // Formato de Salida
                    { text: '[INFO: SKE]', category: 'Formato de Salida' },
                    { text: '[INFO: HPS]', category: 'Formato de Salida' },
                    { text: '[INFO: CAVEAT]', category: 'Formato de Salida' },
                    { text: '[OUTPUT: SPANISH]', category: 'Formato de Salida' },
                    { text: '[OUTPUT: ENGLISH]', category: 'Formato de Salida' }
                ];
                saveDirectives();
            }
            renderDirectives();
        }

        function saveDirectives() {
            localStorage.setItem('vyvia_directives', JSON.stringify(directives));
        }

        function renderDirectives() {
            directivesList.innerHTML = '';
            const groupedDirectives = directives.reduce((acc, directive) => {
                acc[directive.category] = acc[directive.category] || [];
                acc[directive.category].push(directive);
                return acc;
            }, {});

            for (const category in groupedDirectives) {
                const categoryHeader = document.createElement('h3');
                categoryHeader.textContent = category;
                categoryHeader.style.color = 'var(--primary-color)';
                categoryHeader.style.marginTop = '20px';
                directivesList.appendChild(categoryHeader);

                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'directive-category-container';
                groupedDirectives[category].forEach((directive) => {
                    const directiveItem = document.createElement('div');
                    directiveItem.dataset.category = category;
                    directiveItem.className = 'directive-item';

                    if (activeDirectives.includes(directive.text)) {
                        directiveItem.classList.add('selected');
                    }

                    directiveItem.addEventListener('click', () => {
                        const index = activeDirectives.indexOf(directive.text);
                        if (index > -1) {
                            activeDirectives.splice(index, 1);
                        } else {
                            activeDirectives.push(directive.text);
                        }
                        renderActiveDirectives();
                        renderDirectives();
                    });

                    const textSpan = document.createElement('span');
                    textSpan.textContent = directive.text;
                    directiveItem.appendChild(textSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-project-btn'; // Reutilizamos estilo para el botón de borrar
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // Evitar que el click se propague al item
                        const originalIndex = directives.findIndex(d => d.text === directive.text && d.category === directive.category);
                        if (originalIndex > -1) {
                            directives.splice(originalIndex, 1);
                            // También quitar de las directivas activas si estaba ahí
                            const activeIndex = activeDirectives.indexOf(directive.text);
                            if (activeIndex > -1) {
                                activeDirectives.splice(activeIndex, 1);
                            }
                            saveDirectives();
                            renderDirectives();
                            renderActiveDirectives();
                        }
                    };
                    directiveItem.appendChild(deleteBtn);
                    categoryContainer.appendChild(directiveItem);
                });
                directivesList.appendChild(categoryContainer);
            }
        }

        // --- FIN LÓGICA GESTIÓN DE DIRECTIVAS v2.1 ---
        function loadProjects() {
            const storedProjects = localStorage.getItem('vyvia_projects');
            if (storedProjects) {
                projects = JSON.parse(storedProjects);
            } else {
                projects = ['BOT_TRADING', 'WORKBENCH_OS'];
                saveProjects();
            }
            renderProjects();
            loadDirectives(); // Cargar directivas al inicio
            renderActiveDirectives();
        }

        function saveProjects() {
            localStorage.setItem('vyvia_projects', JSON.stringify(projects));
        }


        manageDirectivesBtn.addEventListener('click', () => {
            directivesModal.style.display = 'flex';
            renderDirectives();
        });
        directivesModalCloseBtn.addEventListener('click', () => directivesModal.style.display = 'none');
addDirectiveBtn.addEventListener('click', () => {
    const text = newDirectiveTextInput.value.trim();
    const category = newDirectiveCategorySelector.value;

    if (text && category) {
        if (!directives.some(d => d.text === text)) {
            directives.push({ text, category });
            saveDirectives();
            renderDirectives();
            newDirectiveTextInput.value = '';
        } else {
            alert('Esa directiva ya existe.');
        }
    } else {
        alert('El texto de la directiva no puede estar vacío.');
    }
});

        function renderProjects() {
            // Limpiar listas
            projectSelector.innerHTML = '';
            projectList.innerHTML = '';

            // Poblar <select> y lista del modal
            projects.forEach((project, index) => {
                // Opción para el select
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelector.appendChild(option);

                // Item para la lista del modal
                const listItem = document.createElement('li');
                listItem.className = 'project-list-item';
                listItem.textContent = project;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-project-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    projects.splice(index, 1);
                    saveProjects();
                    renderProjects();
                };

                listItem.appendChild(deleteBtn);
                projectList.appendChild(listItem);
            });
        }

        function addNewProject() {
            const newProjectName = newProjectInput.value.trim().toUpperCase();
            if (newProjectName && !projects.includes(newProjectName)) {
                projects.push(newProjectName);
                saveProjects();
                renderProjects();
                newProjectInput.value = '';
            }
        }

        // Event Listeners del modal
        manageProjectsBtn.addEventListener('click', () => { projectModal.style.display = 'flex'; });
        modalCloseBtn.addEventListener('click', () => { projectModal.style.display = 'none'; });
        window.addEventListener('click', (event) => {
            if (event.target === projectModal) {
                projectModal.style.display = 'none';
            }
        });
        addProjectBtn.addEventListener('click', addNewProject);
        newProjectInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') addNewProject(); 
        });

        // Carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadCategories(); // Cargar categorías al inicio
        });

        // Lógica de modo eliminada

        function getFormattedTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        function showFeedback(buttonElement, message) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = message;
            buttonElement.style.backgroundColor = 'var(--button-active-bg)';
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.backgroundColor = 'var(--button-bg)';
            }, 2000);
        }

        copyButton.addEventListener('click', () => {
            const message = messageInput.value;
            if (!message) { alert('Por favor, escribe un mensaje antes de copiar.'); return; }
            
            // Obtener todos los valores de los inputs
            const timestamp = getFormattedTimestamp();
            const projectContext = projectSelector.value || "General";
            const chatSession = chatSessionInput.value;
            const protocolDirective = activeDirectives.join(' ');

            if (!chatSession) { alert('Por favor, especifica el número de sesión (ej. C9.1)'); return; }

            // Construir la cabecera y el mensaje final
            const header = `${chatSession} | [PROYECTO: ${projectContext}] | [MODO: DEEP FOCUS] | ${timestamp}`;
            let fullMessage;

            // Condicionalmente añadir la directiva si existe
            if (protocolDirective) {
                fullMessage = `${header}\n${protocolDirective}\n\n${message}`;
            } else {
                fullMessage = `${header}\n\n${message}`;
            }


            navigator.clipboard.writeText(fullMessage).then(() => {
                showFeedback(copyButton, '¡Copiado!');
            }).catch(err => alert('Hubo un error al intentar copiar el texto.'));
        });

        // --- Lógica de Notas Rápidas (NUEVO) ---
        const notesInput = document.getElementById('notes-input');
        const copyNoteButton = document.getElementById('copy-note-button');

        copyNoteButton.addEventListener('click', () => {
            const noteText = notesInput.value;
            if (!noteText) { alert('Por favor, escribe una nota antes de copiar.'); return; }
            
            const timestamp = getFormattedTimestamp();
            const fullNote = `[NOTA RÁPIDA | ${timestamp}]\n${noteText}`;

            navigator.clipboard.writeText(fullNote).then(() => {
                showFeedback(copyNoteButton, '¡Nota Copiada!');
                notesInput.value = ''; // Limpiar el campo después de copiar
            }).catch(err => alert('Hubo un error al intentar copiar la nota.'));
        });

    // --- Lógica para gestionar categorías (Modal, etc.) ---
    const manageCategoriesBtn = document.getElementById('manage-categories-btn');
    // Crear el modal de categorías dinámicamente o tenerlo en el HTML y mostrarlo.
    // Aquí un ejemplo simplificado:
    function loadCategories() {
        const storedCategories = localStorage.getItem('vyvia_directive_categories');
        if (storedCategories) {
            categories = JSON.parse(storedCategories);
        } else {
            categories = ['Modo Cognitivo', 'Control de Ejecución', 'Formato de Salida'];
            saveCategories();
        }
        renderCategorySelector();
    }

    function saveCategories() {
        localStorage.setItem('vyvia_directive_categories', JSON.stringify(categories));
    }

    manageCategoriesBtn.addEventListener('click', () => {
        // Aquí iría la lógica para mostrar un modal de gestión de categorías
        // Por simplicidad, usaremos un prompt por ahora:
        const newCategoryList = prompt('Gestionar categorías (separadas por coma):', categories.join(', '));
        if (newCategoryList !== null) {
            categories = newCategoryList.split(',').map(c => c.trim()).filter(Boolean);
            saveCategories();
            renderCategorySelector();
            renderDirectives(); // para actualizar colores si es necesario
        }
    });
    </script>
</body>
</html>